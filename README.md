# Fastlane Remote Config + Gitlab CI/CD

Репозиторий содержит конфигурацию сборщика мобильных приложений, которую можно использовать без включения в сами проекты мобильных приложений, а также запускать на различных CI/CD. В данном случае будет рассматриваться использование в Gitlab CI/CD.

## Агент

Физическая машина, на которой запущен Gitlab Runner, настроенный на выполнение определенных задач CI.

## Авторизация в учетной записи Apple

Для осуществления сборки iOS приложений, по мимо указания общих сведений в конфигурации проекта, требуется авторизация в учётной записи владельца apple_id. Авторизацию нужно выполнять через Fastlane CredentialsManager, используя двухфакторную аутентификацию, чтобы не хранить эти данные в открытом доступе. Для того, чтобы это сделать, нужно выполнить несколько команд на агенте (потребуется ручной ввод пароля):

- Сгенерировать apple app-specific password (https://support.apple.com/en-us/HT204397)
- Добавить учетные данные владельца apple_id в keychain

```bash
$ fastlane fastlane-credentials add --username <apple_id>
```

- Сгенерировать сессионный ключ

```bash
$ fastlane spaceauth -u <apple_id>
```

- Сохранить, полученные пароль и ключ в закрытых переменных проекта в Gitlab (https://docs.gitlab.com/ee/ci/variables/#mask-a-custom-variable)

```bash
FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD - сгенерированный пароль
FASTLANE_SESSION - сгенирированный сессионный ключ
```

> **WARNING**: FASTLANE_SESSION выписывается на 1 месяц, поэтому его нужно обновлять вручную.

## Конфигурация Fastlane в проекте

Чтобы агент мог вызывать команды сборщика внутри проекта, используя общую конфигурацию, нужно добавить локальную конфигурацию Fastlane по шаблону. В корне проекта мобильного приложения нужно создать папку fastlane и скопировать в нее файлы конфигурации из репозитория https://github.com/quarrant/fastlane-remote-config/tree/master/app-config и проставить свои значения переменных.

> **Appfile** - общие переменные проекта. **Matchfile** - конфигурация для работы с сертификатами (iOS), часть переменных загружается из **Appfile**, чтобы избежать дублирования. **Fastfile** - точка входа для сборщика, содержит только импорт конфигурации из общего репозитория.

## Подпись приложений

### Сертификаты (iOS)

Содержимое репозиторий, указанный в `git_url("git@github.com:quarrant/fastlane-match-certificates.git")` в **Matchfile** указывает на репозиторий для хранения сгенерированных сертификатов. Это должен быть приватный репозиторий.

Для упрощения работы с получением и обновлением сертификатов применяется механизм fastlane match. Что это значит? Сертификаты выписываются 1 раз и сохраняются в репозитории. Так как проект настраивается на сертификаты выписанные через fastlane match, то и разработчики должны выписывать себе сертификаты через этот механизм.

**Генерация новых сертификатов**

Перед началом работы с fastlane match нужно создать сертификаты в репозитории. Делать это можно на любом устройстве, имеющем доступ к учетным данным владельца apple_id. Переходим в корень проекта и выполняем команду:

```bash
$ fastlane match development # создает сертификат разработчика
$ fastlane match appstore # создает сертификат для релизной сборки
```

После этого, созданные сертификаты добавятся в Keychain и запишутся в репозиторий, в ветку соответствующую team_id, указанному в Appfile. Если сертификаты уже есть в репозитории, то они просто будут добавлены в Keychain.

> Чтобы пересоздать сертификаты нужно использовать флаг --force

**Загрузка существующих сертификатов**

Чтобы загрузить себе сертификат разработчика нужно в корне проекта выполнить команду:

```bash
$ fastlane match development --readonly
```

После ее выполнения сертификат и provision будут добавлены в Keychain.

> При указании флага --readonly сертификаты будут просто загружены, при их наличии в репозитории. Отсутствующие сертификаты создаваться не будут.

### Keystore (Android)

Все параметры, которые были указаны при первоначальной генерации keystore должны быть указываны в закрытых переменных Gitlab (https://docs.gitlab.com/ee/ci/variables/#mask-a-custom-variable), в том числе и сам keystore, закодированный в base64.
